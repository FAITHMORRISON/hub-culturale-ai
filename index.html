<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mio Hub Culturale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #f0f2f5; --card: #ffffff; --text: #2d3436;
            --primary: #6c5ce7; --secondary: #a29bfe;
        }
        .dark-mode {
            --bg: #1a1a1a; --card: #2d2d2d; --text: #f5f6fa;
            --primary: #a29bfe;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); transition: 0.3s; margin: 0; padding: 15px; overflow-x: hidden; }
        .container { max-width: 500px; margin: auto; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .dark-toggle { cursor: pointer; font-size: 20px; color: var(--primary); }

        .input-card { background: var(--card); padding: 15px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom: 25px; }
        textarea { width: 100%; height: 100px; background: transparent; color: var(--text); border: 1px solid #ddd; border-radius: 10px; padding: 12px; box-sizing: border-box; resize: none; font-size: 16px; outline: none; }
        .input-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        #charCount { font-size: 12px; color: #636e72; }

        button#btnSalva { 
            padding: 12px 20px; background: var(--primary); color: white; border: none; 
            border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 16px;
        }

        .spinner { display: none; width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Accordion */
        .acc-item { background: var(--card); margin-bottom: 12px; border-radius: 12px; overflow: hidden; border-left: 6px solid var(--c); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .acc-header { width: 100%; padding: 18px; display: flex; justify-content: space-between; align-items: center; background: none; border: none; cursor: pointer; font-size: 16px; font-weight: bold; color: var(--text); }
        .acc-content { display: none; padding: 0 15px 15px 15px; background: rgba(0,0,0,0.01); }
        .acc-content.active { display: block; }

        /* Note */
        .item-nota { background: var(--bg); padding: 12px; border-radius: 10px; margin-top: 10px; position: relative; border: 1px solid rgba(0,0,0,0.05); word-wrap: break-word; }
        .item-actions { display: flex; gap: 15px; margin-top: 10px; justify-content: flex-end; align-items: center; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 16px; color: #636e72; }
        .item-date { font-size: 10px; opacity: 0.6; flex-grow: 1; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #2d3436; color: white; padding: 12px 25px; border-radius: 30px; display: none; font-size: 14px; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="toast">Messaggio</div>

    <div class="container">
        <header>
            <h1>üß† Hub Culturale</h1>
            <div class="dark-toggle" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></div>
        </header>

        <div class="input-card">
            <textarea id="userInput" oninput="updateCharCount()" placeholder="Incolla link o scrivi..."></textarea>
            <div class="input-footer">
                <span id="charCount">Caratteri: 0</span>
                <button id="btnSalva" onclick="gestisciInvio()">
                    <div class="spinner" id="spinner"></div>
                    <span id="btnText"><i class="fas fa-magic"></i> Organizza</span>
                </button>
            </div>
        </div>

        <div class="accordion-container">
            <div class="acc-item" style="--c: #3498db;">
                <button class="acc-header" onclick="toggleAcc('list-musica')"><span><i class="fas fa-music"></i> Musica</span><i class="fas fa-chevron-down"></i></button>
                <div class="acc-content" id="list-musica"></div>
            </div>
            <div class="acc-item" style="--c: #e67e22;">
                <button class="acc-header" onclick="toggleAcc('list-libri')"><span><i class="fas fa-book"></i> Libri</span><i class="fas fa-chevron-down"></i></button>
                <div class="acc-content" id="list-libri"></div>
            </div>
            <div class="acc-item" style="--c: #9b59b6;">
                <button class="acc-header" onclick="toggleAcc('list-arte')"><span><i class="fas fa-palette"></i> Arte & Ref</span><i class="fas fa-chevron-down"></i></button>
                <div class="acc-content" id="list-arte"></div>
            </div>
            <div class="acc-item" style="--c: #2ecc71;">
                <button class="acc-header" onclick="toggleAcc('list-tutorial')"><span><i class="fas fa-lightbulb"></i> Tutorial</span><i class="fas fa-chevron-down"></i></button>
                <div class="acc-content" id="list-tutorial"></div>
            </div>
            <div class="acc-item" style="--c: #95a5a6;">
                <button class="acc-header" onclick="toggleAcc('list-extra')"><span><i class="fas fa-folder"></i> Altro</span><i class="fas fa-chevron-down"></i></button>
                <div class="acc-content" id="list-extra"></div>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzUTtg3KipG2nn4Aq7nfJ7pxL-y_Xgu9gZ6xhbpnfOvgeEdlklq0WsvkrBz_nlcmiLpNQ/exec";

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.querySelector('.dark-toggle i');
            icon.classList.toggle('fa-moon'); icon.classList.toggle('fa-sun');
        }

        function updateCharCount() {
            document.getElementById('charCount').textContent = `Caratteri: ${document.getElementById('userInput').value.length}`;
        }

        function toggleAcc(id) { document.getElementById(id).classList.toggle('active'); }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2500);
        }

        async function gestisciInvio() {
            const area = document.getElementById('userInput');
            const testo = area.value.trim();
            if(!testo) return;

            // UI Loading
            document.getElementById('spinner').style.display = 'block';
            document.getElementById('btnText').style.display = 'none';
            document.getElementById('btnSalva').disabled = true;

            // Smistamento Categorie Temporaneo (In attesa dell'AI)
            let cat = "extra";
            const t = testo.toLowerCase();
            if(t.includes("tutorial") || t.includes("come")) cat = "tutorial";
            else if(t.includes("musica") || t.includes("canzone")) cat = "musica";
            else if(t.includes("libro") || t.includes("autore")) cat = "libri";
            else if(t.includes("arte") || t.includes("mostra")) cat = "arte";

            const payload = {
                testo: testo,
                categoria: cat,
                note_ai: "Salvataggio manuale"
            };

            try {
                // INVIO AL DATABASE GOOGLE
                await fetch(WEB_APP_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                // Se arriviamo qui, l'invio √® partito
                aggiungiNotaAFVideo(testo, cat);
                area.value = "";
                updateCharCount();
                showToast("‚úÖ Salvato nel Database!");
            } catch (error) {
                showToast("‚ùå Errore di connessione");
                console.error(error);
            } finally {
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('btnText').style.display = 'block';
                document.getElementById('btnSalva').disabled = false;
            }
        }

        function aggiungiNotaAFVideo(testo, cat) {
            const lista = document.getElementById('list-' + cat);
            const data = new Date().toLocaleString('it-IT', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
            const div = document.createElement('div');
            div.className = 'item-nota';
            div.innerHTML = `
                <div>${testo}</div>
                <div class="item-actions">
                    <span class="item-date">${data}</span>
                    <button class="action-btn" onclick="navigator.clipboard.writeText('${testo.replace(/'/g, "\\'")}'); showToast('Copiato!')"><i class="fas fa-copy"></i></button>
                </div>
            `;
            lista.prepend(div);
            lista.classList.add('active');
        }
    </script>
</body>
</html>
